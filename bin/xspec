#!/usr/bin/env ruby

require 'optparse'

$LOAD_PATH.unshift File.expand_path("../../lib", __FILE__)

require 'xspec'

$LOAD_PATH.unshift "spec"
$LOAD_PATH.unshift "lib"

filter    = //
short_ids = []

parser = OptionParser.new
parser.banner = "Usage: xspec [options] [files]"
parser.separator ""
parser.on('-e FILTER', "Only run specs with full name including FILTER") do |f|
  filter = Regexp.new(f)
end
parser.on('-f ID', "Run spec with short id ID. Overrides -e option.") do |f|
  short_ids << f
end
parser.on("-h", "--help", "Show this message") do
  $stderr.puts parser
  exit
end
parser.separator ""

parser.parse!


files = if ARGV.any? {|x| x.length > 0 }
  ARGV
else
  Dir['spec/**/*_spec.rb']
end

files.each do |f|
  load f
end

if respond_to?(:run!)
  exit 1 unless run!(scheduler: XSpec::Scheduler::Filter.new(
    scheduler: __xspec_opts.fetch(:scheduler),
    filter:    -> uow {
      if short_ids.any?
        short_ids.include?(XSpec.short_id(uow.full_name))
      else
        uow.full_name =~ filter
      end
    }
  ))
else
  $stderr.puts "This script can only be used when XSpec.dsl is mixed in to " +
               "global scope."
  exit 1
end
